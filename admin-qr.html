<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<parameter name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Management - Smart Farming Admin</title>
<link rel="stylesheet" href="style.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<style>
.admin-page {
  padding: 20px;
  max-width: 1200px;
  margin: 0 auto;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.stat-card h3 {
  margin: 0 0 10px 0;
  font-size: 14px;
  color: #666;
}

.stat-card .stat-value {
  font-size: 32px;
  font-weight: bold;
  color: var(--primary);
}

.active-qr-card {
  background: linear-gradient(135deg, var(--primary), #9333ea);
  color: white;
  border-radius: 12px;
  padding: 25px;
  margin-bottom: 30px;
}

.active-qr-card h2 {
  margin: 0 0 15px 0;
}

.qr-controls {
  display: flex;
  gap: 10px;
  margin-bottom: 30px;
}

.btn {
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.qr-table {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th {
  text-align: left;
  padding: 12px;
  border-bottom: 2px solid #e0e0e0;
  color: #555;
  font-weight: 600;
}

td {
  padding: 12px;
  border-bottom: 1px solid #f0f0f0;
}

.badge {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}

.badge-active {
  background: #d4edda;
  color: #155724;
}

.badge-inactive {
  background: #f8d7da;
  color: #721c24;
}

.action-btn {
  padding: 6px 12px;
  margin: 0 5px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
}

.pending-transactions {
  background: white;
  border-radius: 12px;
  padding: 20px;
  margin-top: 30px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
}

.modal-content {
  background: white;
  margin: 10% auto;
  padding: 30px;
  border-radius: 12px;
  width: 90%;
  max-width: 500px;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
}

.form-group input {
  width: 100%;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
}
</style>
</head>
<body>

<div class="page-header-back" style="background: var(--primary); color: white; padding: 15px 20px;">
  <h1 style="margin:0;">QR Rotation Management</h1>
</div>

<div class="admin-page">
  <div class="stats-grid">
    <div class="stat-card">
      <h3>Total QR Codes</h3>
      <div class="stat-value" id="totalQRs">0</div>
    </div>
    <div class="stat-card">
      <h3>Total Payments</h3>
      <div class="stat-value" id="totalPayments">0</div>
    </div>
    <div class="stat-card">
      <h3>Active QR Position</h3>
      <div class="stat-value" id="activeQRPosition">-</div>
    </div>
  </div>

  <div class="active-qr-card" id="activeQRCard">
    <h2>ðŸŽ¯ Current Active QR</h2>
    <p style="font-size: 24px; margin: 10px 0;"><strong id="activeQRUPI">Loading...</strong></p>
    <p style="margin: 5px 0;">Payments: <strong id="activeQRPayments">0</strong> / <strong id="activeQRMax">10</strong></p>
    <p style="margin: 5px 0; opacity: 0.9;" id="activeQRStatus">Ready to receive payments</p>
  </div>

  <div class="qr-controls">
    <button class="btn btn-primary" onclick="openAddModal()"><i class="bi bi-plus-circle"></i> Add QR Code</button>
    <button class="btn btn-secondary" onclick="manualRotate()"><i class="bi bi-arrow-repeat"></i> Manual Rotate</button>
    <button class="btn btn-secondary" onclick="loadBulkQRs()"><i class="bi bi-upload"></i> Bulk Add (100 QRs)</button>
  </div>

  <div class="qr-table">
    <h3>All QR Codes</h3>
    <table>
      <thead>
        <tr>
          <th>Position</th>
          <th>UPI ID</th>
          <th>Payments</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="qrTableBody">
        <tr>
          <td colspan="5" style="text-align:center; color:#999;">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="pending-transactions">
    <h3>Pending Approvals</h3>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>User Phone</th>
          <th>Amount</th>
          <th>UTR</th>
          <th>Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="pendingTableBody">
        <tr>
          <td colspan="6" style="text-align:center; color:#999;">No pending transactions</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Add QR Modal -->
<div id="addQRModal" class="modal">
  <div class="modal-content">
    <h2>Add New QR Code</h2>
    <div class="form-group">
      <label>UPI ID</label>
      <input type="text" id="newQRUPI" placeholder="example@paytm or 9876543210@ybl">
    </div>
    <div style="display: flex; gap: 10px;">
      <button class="btn btn-primary" onclick="addQRCode()">Add</button>
      <button class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
const API_BASE = window.location.origin + '/api';

async function loadStats() {
  try {
    const response = await fetch(API_BASE + '/admin/qr/stats');
    const stats = await response.json();
    
    document.getElementById('totalQRs').textContent = stats.totalQRs;
    document.getElementById('totalPayments').textContent = stats.totalPayments;
    
    if (stats.activeQR) {
      document.getElementById('activeQRPosition').textContent = stats.activeQR.qr_position;
      document.getElementById('activeQRUPI').textContent = stats.activeQR.upi_id;
      document.getElementById('activeQRPayments').textContent = stats.activeQR.successful_payments;
      document.getElementById('activeQRMax').textContent = stats.activeQR.max_payments_per_qr;
      
      const remaining = stats.activeQR.max_payments_per_qr - stats.activeQR.successful_payments;
      document.getElementById('activeQRStatus').textContent = `${remaining} payments until rotation`;
    }
  } catch (error) {
    console.error('Failed to load stats:', error);
  }
}

async function loadQRCodes() {
  try {
    const response = await fetch(API_BASE + '/admin/qr/all');
    const data = await response.json();
    
    const tbody = document.getElementById('qrTableBody');
    
    if (data.qrCodes.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999;">No QR codes found</td></tr>';
      return;
    }
    
    tbody.innerHTML = data.qrCodes.map(qr => `
      <tr>
        <td><strong>#${qr.qr_position}</strong></td>
        <td>${qr.upi_id}</td>
        <td>${qr.successful_payments} / ${qr.max_payments_per_qr}</td>
        <td>
          <span class="badge ${qr.is_active ? 'badge-active' : 'badge-inactive'}">
            ${qr.is_active ? 'Active' : 'Inactive'}
          </span>
        </td>
        <td>
          <button class="action-btn" style="background:#dc3545; color:white;" onclick="deleteQR(${qr.id})">Delete</button>
        </td>
      </tr>
    `).join('');
  } catch (error) {
    console.error('Failed to load QR codes:', error);
  }
}

async function loadPendingTransactions() {
  try {
    const response = await fetch(API_BASE + '/admin/transactions/pending');
    const data = await response.json();
    
    const tbody = document.getElementById('pendingTableBody');
    
    if (data.transactions.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#999;">No pending transactions</td></tr>';
      return;
    }
    
    tbody.innerHTML = data.transactions.map(t => `
      <tr>
        <td>${t.id}</td>
        <td>${t.phone}</td>
        <td>â‚¹${parseFloat(t.amount).toFixed(2)}</td>
        <td>${t.utr_number || 'N/A'}</td>
        <td>${new Date(t.created_at).toLocaleString()}</td>
        <td>
          <button class="action-btn" style="background:#28a745; color:white;" onclick="approveTransaction(${t.id})">
            Approve
          </button>
        </td>
      </tr>
    `).join('');
  } catch (error) {
    console.error('Failed to load pending transactions:', error);
  }
}

async function approveTransaction(transactionId) {
  if (!confirm('Approve this recharge? This will credit the user balance and count toward QR rotation.')) return;
  
  try {
    const response = await fetch(API_BASE + '/admin/recharge/approve', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ transactionId })
    });
    
    const data = await response.json();
    alert(data.message || 'Recharge approved!');
    loadStats();
    loadQRCodes();
    loadPendingTransactions();
  } catch (error) {
    alert('Failed to approve recharge');
  }
}

function openAddModal() {
  document.getElementById('addQRModal').style.display = 'block';
}

function closeAddModal() {
  document.getElementById('addQRModal').style.display = 'none';
  document.getElementById('newQRUPI').value = '';
}

async function addQRCode() {
  const upiId = document.getElementById('newQRUPI').value.trim();
  
  if (!upiId) {
    alert('Please enter a UPI ID');
    return;
  }
  
  try {
    const response = await fetch(API_BASE + '/admin/qr/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ upiId })
    });
    
    const data = await response.json();
    alert(data.message);
    closeAddModal();
    loadStats();
    loadQRCodes();
  } catch (error) {
    alert('Failed to add QR code');
  }
}

async function deleteQR(id) {
  if (!confirm('Delete this QR code?')) return;
  
  try {
    const response = await fetch(API_BASE + '/admin/qr/delete/' + id, {
      method: 'DELETE'
    });
    
    const data = await response.json();
    alert(data.message);
    loadStats();
    loadQRCodes();
  } catch (error) {
    alert('Failed to delete QR code');
  }
}

async function manualRotate() {
  if (!confirm('Manually rotate to next QR code?')) return;
  
  try {
    const response = await fetch(API_BASE + '/admin/qr/rotate', {
      method: 'POST'
    });
    
    const data = await response.json();
    alert(data.message);
    loadStats();
    loadQRCodes();
  } catch (error) {
    alert('Failed to rotate QR');
  }
}

async function loadBulkQRs() {
  const count = prompt('How many QR codes to add? (Enter UPI IDs will be generated as qr1@paytm, qr2@paytm, etc.)', '100');
  
  if (!count || isNaN(count) || count < 1) return;
  
  if (!confirm(`Add ${count} QR codes with auto-generated UPI IDs?`)) return;
  
  try {
    for (let i = 1; i <= parseInt(count); i++) {
      await fetch(API_BASE + '/admin/qr/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ upiId: `qr${i}@paytm` })
      });
    }
    
    alert(`${count} QR codes added successfully!`);
    loadStats();
    loadQRCodes();
  } catch (error) {
    alert('Failed to bulk add QR codes');
  }
}

// Initial load
loadStats();
loadQRCodes();
loadPendingTransactions();

// Auto refresh every 30 seconds
setInterval(() => {
  loadStats();
  loadQRCodes();
  loadPendingTransactions();
}, 30000);
</script>
</body>
</html>
